module;

//---------------------------------------------------------------------------------------------------------------

#include <string>
#include <unordered_map>
#include <vector>

//---------------------------------------------------------------------------------------------------------------

export module name_table;

//---------------------------------------------------------------------------------------------------------------

export namespace ParaCL
{

//---------------------------------------------------------------------------------------------------------------

struct NameValue
{
    int value;
};

//---------------------------------------------------------------------------------------------------------------

struct NameTable
{
    std::vector<std::unordered_map<std::string, NameValue>> scopes;

    void enter();
    void leave();
    NameValue *lookup(const std::string &name);
    void declare(const std::string &name, const int value);
};

//---------------------------------------------------------------------------------------------------------------

void NameTable::enter()
{
    scopes.emplace_back();
}

//---------------------------------------------------------------------------------------------------------------

void NameTable::leave()
{
    scopes.pop_back();
}

//---------------------------------------------------------------------------------------------------------------

NameValue *NameTable::lookup(const std::string &name)
{
    for (auto it = scopes.rbegin(), itend = scopes.rend(); it < itend; ++it)
    {
        auto founded = it->find(name);

        if (founded != it->end())
            return &(founded->second);
    }
    return nullptr;
}

//---------------------------------------------------------------------------------------------------------------

void NameTable::declare(const std::string &name, const int value)
{
    scopes.back()[name] = {value};
}

//---------------------------------------------------------------------------------------------------------------

} // namespace ParaCL

//---------------------------------------------------------------------------------------------------------------
